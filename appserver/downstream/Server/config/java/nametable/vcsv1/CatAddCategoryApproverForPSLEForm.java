 /*********************************************************************************
Name:Shailaja M Salimath
Date:18/03/09
Issue No.:886
Description: Nametable for Category Approver field on preffered Supplier eform
S. Sato - AUL - 23rd Dec 2010    - Added condition to not return anything if the user hasn't selected a supplier    category. Prevents the AQLParseException if the supplier category list is empty    - Formatting and indentation correction
*************************************************************************************/
package config.java.nametable.vcsv1;
import java.util.List;import ariba.base.core.Base;import ariba.base.core.BaseId;import ariba.base.core.ClusterRoot;import ariba.base.core.aql.AQLNameTable;import ariba.base.core.aql.AQLQuery;import ariba.base.core.aql.SearchTermQuery;import ariba.base.fields.ValueSource;import ariba.basic.core.CommodityCode;import ariba.user.core.Role;import ariba.util.log.Log;
public class CatAddCategoryApproverForPSLEForm extends AQLNameTable {
    protected AQLQuery buildQuery (AQLQuery query, String field, String pattern, SearchTermQuery searchTermQuery)    {        ValueSource object = getValueSourceContext();        Log.customer.debug("The object is" + object);        ClusterRoot cluster = (ClusterRoot) object;        if (cluster != null) {            List categories = (List) cluster.getFieldValue("SupplierCategoriesToAdd");            if (categories != null) {                Log.customer.debug("CatAddCategoryApproverForPSLEForm :categories " + categories);            }            String criteria = null;                // S. Sato - AUL - User has selected some supplier categories            if (!categories.isEmpty()) {                String queryText =  "select Usr " +                                    "from ariba.user.core.User Usr,ariba.user.core.Group G " +                                     "where Usr=G.Users and G.UniqueName IN (" ;                for (int i = 0; i < categories.size(); i++) {                    ClusterRoot ca = Base.getSession().objectFromId((BaseId)categories.get(i));                    Log.customer.debug("CatAddCategoryApproverForPSLEForm ca", ca);                    if (ca instanceof CommodityCode) {                        String categoriunique = (String) ca.getDottedFieldValue("UniqueName");                        if (categoriunique != null) {                            Log.customer.debug("CatAddCategoryApproverForPSLEForm: " + categoriunique );                            String catun = categoriunique.substring(0,2);                            Log.customer.debug("CatAddCategoryApproverForPSLEForm : " + catun);                            String catapproverstr = "Category Approver ("+catun+")";                            Log.customer.debug("CatAddCategoryApproverForPSLEForm: " + catapproverstr );                            Role Role_Category_Approver = Role.getRole(catapproverstr);                            if (Role_Category_Approver != null) {                                Log.customer.debug(" CatAddCategoryApproverForPSLEForm ROLE"+Role_Category_Approver);                                String Role_Category_Approver_UniqueName =                                    (String) Role_Category_Approver.getUniqueName();                                if (Role_Category_Approver_UniqueName != null && i == 0) {                                    Log.customer.debug(" CatAddCategoryApproverForPSLEForm ROLE" + Role_Category_Approver_UniqueName);                                    criteria = "'" + Role_Category_Approver_UniqueName + "'";                                }                                else {                                    Log.customer.debug(" CatAddCategoryApproverForPSLEForm ROLE in esle "+Role_Category_Approver_UniqueName);                                    criteria = criteria + ",'" + Role_Category_Approver_UniqueName + "'";                                }                            }                        }                    }                } // for
                criteria = criteria + ")";                queryText = queryText + criteria;                Log.customer.debug("CatAddCategoryApproverForPSLEForm Query Text"+queryText);                query = AQLQuery.parseQuery(queryText);                query = super.buildQuery(query, field, pattern, searchTermQuery);            }                // S. Sato - AUL - no supplier categories selected by the user            else {                    // create a false query - we don't want to return anything                String queryText =  "select Usr " +                        "from ariba.user.core.User Usr,ariba.user.core.Group G " +                        "where Usr=G.Users and 1=2" ;                Log.customer.debug("CatAddCategoryApproverForPSLEForm No Categories Set");                Log.customer.debug("CatAddCategoryApproverForPSLEForm False Query Text" + queryText);                query = AQLQuery.parseQuery(queryText);                query = super.buildQuery(query, field, pattern, searchTermQuery);            }        }        return query;    }
    public CatAddCategoryApproverForPSLEForm(){
    }
    private static final String classname = "CatAddCategoryApproverForPSLEForm : ";}